<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CINEMATCH - Tu Dating Profile Cinematogr√°fico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        .story-card {
            width: 100%;
            max-width: 540px;
            aspect-ratio: 9/16;
            min-height: 100vh;
        }
        @media (min-width: 640px) {
            .story-card {
                width: 540px;
                height: 960px;
            }
        }
        .slide-container {
            position: relative;
            overflow: hidden;
        }
        .slide-content {
            touch-action: pan-y;
            animation: slideIn 0.4s ease-out;
            overflow-y: auto;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .slide-nudge {
            animation: slideNudge 1.5s ease-in-out 3;
        }
        @keyframes slideNudge {
            0%, 100% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-10px);
            }
            75% {
                transform: translateX(0);
            }
        }
        .progress-bar {
            transition: width 0.1s linear;
        }
        .slide-indicator {
            transition: all 0.3s ease;
        }
        .slide-indicator.active {
            transform: scale(1.2);
        }
        .slide-indicators-floating {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            max-width: 540px;
            width: 100%;
            z-index: 100;
            background: linear-gradient(to bottom, rgba(15, 20, 25, 0.95) 0%, rgba(15, 20, 25, 0.8) 70%, rgba(15, 20, 25, 0) 100%);
            backdrop-filter: blur(8px);
            pointer-events: none;
        }
        .slide-indicators-floating > * {
            pointer-events: auto;
        }
        .nav-arrow {
            display: none;
        }
        @media (min-width: 640px) {
            .nav-arrow {
                display: flex;
                align-items: center;
                justify-content: center;
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                width: 48px;
                height: 48px;
                background: rgba(255, 0, 110, 0.9);
                border-radius: 50%;
                cursor: pointer;
                transition: all 0.3s ease;
                z-index: 50;
            }
            .nav-arrow:hover {
                background: rgba(255, 0, 110, 1);
                transform: translateY(-50%) scale(1.1);
            }
            .nav-arrow:disabled {
                opacity: 0.3;
                cursor: not-allowed;
            }
            .nav-arrow:disabled:hover {
                transform: translateY(-50%) scale(1);
            }
            .nav-arrow-left {
                left: -24px;
            }
            .nav-arrow-right {
                right: -24px;
            }
        }
    </style>
</head>
<body class="bg-[#0f1419] min-h-screen">
    <div id="root" class="container mx-auto px-4 py-8 max-w-2xl"></div>

    <script>
        // Detectar si estamos en entorno de desarrollo/preview
        // isDevelopment = true para: localhost, 127.0.0.1, y preview deployments de Vercel (con -git-)
        const isDevelopment = window.location.hostname === 'localhost' ||
                              window.location.hostname === '127.0.0.1' ||
                              window.location.hostname.includes('-git-'); // Vercel preview deployments
        const isProduction = !isDevelopment;

        // State management
        let state = {
            image: null,
            loading: false,
            result: null,
            error: null,
            useMock: false,
            currentSlide: 0,
            autoSlideTimer: null,
            swipeIndicatorTimer: null,
            touchStartX: 0,
            touchEndX: 0,
            touchStartY: 0,
            touchEndY: 0,
            autoSlideEnabled: true,
            hasCompletedCycle: false,
            hasScrolledToResults: false,
            wasRestoredFromStorage: false,
            profileCode: null,
            view: 'home', // 'home', 'results', 'compatibility-input', 'compatibility-results'
            compatibilityResult: null,
            compatibilityUser: null,
            compatibilityCrush: null,
            pronoun: 'neutro', // 'masculino', 'femenino', 'neutro'
            crushPronoun: 'neutro' // 'masculino', 'femenino', 'neutro'
        };

        function setState(updates) {
            state = { ...state, ...updates };
            render();

            // Save to localStorage when results change
            if (updates.result !== undefined && state.view === 'results') {
                saveStandardToLocalStorage();
            }
            if (updates.compatibilityResult !== undefined && state.view === 'compatibility-results') {
                saveCompatibilityToLocalStorage();
            }
        }

        // LocalStorage functions - Redise√±adas para soportar 2 tipos de resultados
        const STORAGE_KEY_STANDARD = 'cinematch_standard_results';
        const STORAGE_KEY_COMPATIBILITY = 'cinematch_compatibility_results';
        const STORAGE_EXPIRATION_DAYS = 7;

        function saveStandardToLocalStorage() {
            try {
                const dataToSave = {
                    type: 'standard',
                    result: state.result,
                    image: state.image,
                    profileCode: state.profileCode,
                    timestamp: Date.now()
                };
                localStorage.setItem(STORAGE_KEY_STANDARD, JSON.stringify(dataToSave));
                console.log('Standard results saved to localStorage');
            } catch (error) {
                console.error('Error saving standard results:', error);
            }
        }

        function saveCompatibilityToLocalStorage() {
            try {
                const dataToSave = {
                    type: 'compatibility',
                    compatibilityResult: state.compatibilityResult,
                    timestamp: Date.now()
                };
                localStorage.setItem(STORAGE_KEY_COMPATIBILITY, JSON.stringify(dataToSave));
                console.log('Compatibility results saved to localStorage');
            } catch (error) {
                console.error('Error saving compatibility results:', error);
            }
        }

        function loadFromLocalStorage() {
            const expirationMs = STORAGE_EXPIRATION_DAYS * 24 * 60 * 60 * 1000;

            try {
                // Intentar cargar resultados standard
                const savedStandard = localStorage.getItem(STORAGE_KEY_STANDARD);
                if (savedStandard) {
                    const data = JSON.parse(savedStandard);
                    if (Date.now() - data.timestamp < expirationMs) {
                        console.log('Loading standard results from localStorage');
                        return {
                            type: 'standard',
                            result: data.result,
                            image: data.image,
                            profileCode: data.profileCode
                        };
                    } else {
                        localStorage.removeItem(STORAGE_KEY_STANDARD);
                    }
                }

                // Intentar cargar resultados de compatibilidad
                const savedCompatibility = localStorage.getItem(STORAGE_KEY_COMPATIBILITY);
                if (savedCompatibility) {
                    const data = JSON.parse(savedCompatibility);
                    if (Date.now() - data.timestamp < expirationMs) {
                        console.log('Loading compatibility results from localStorage');
                        return {
                            type: 'compatibility',
                            compatibilityResult: data.compatibilityResult
                        };
                    } else {
                        localStorage.removeItem(STORAGE_KEY_COMPATIBILITY);
                    }
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
            }
            return null;
        }

        function clearLocalStorage() {
            try {
                localStorage.removeItem(STORAGE_KEY_STANDARD);
                localStorage.removeItem(STORAGE_KEY_COMPATIBILITY);
                console.log('localStorage cleared');
            } catch (error) {
                console.error('Error clearing localStorage:', error);
            }
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    setState({
                        image: e.target.result,
                        result: null,
                        error: null,
                        wasRestoredFromStorage: false
                    });
                };
                reader.readAsDataURL(file);
            }
        }

        async function analyzeProfile() {
            if (!state.image) return;

            setState({ loading: true, error: null });

            try {
                const base64Data = state.image.split(',')[1];

                // Llamar a nuestra funci√≥n serverless
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        imageData: base64Data,
                        useMock: state.useMock,
                        pronoun: state.pronoun
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                let analysisText = data.content.find(item => item.type === 'text')?.text || '';

                analysisText = analysisText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();

                const analysis = JSON.parse(analysisText);

                // Guardar perfil y obtener c√≥digo
                try {
                    const saveResponse = await fetch('/api/save-profile', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ profile: analysis })
                    });

                    if (saveResponse.ok) {
                        const { code } = await saveResponse.json();
                        setState({ result: analysis, profileCode: code, loading: false, wasRestoredFromStorage: false, view: 'results' });
                    } else {
                        // Si falla guardar el c√≥digo, igual mostramos resultados
                        setState({ result: analysis, loading: false, wasRestoredFromStorage: false, view: 'results' });
                    }
                } catch (codeError) {
                    console.error('Error saving profile code:', codeError);
                    // Si falla, igual mostramos resultados sin c√≥digo
                    setState({ result: analysis, loading: false, wasRestoredFromStorage: false, view: 'results' });
                }
            } catch (err) {
                console.error('Error:', err);
                setState({
                    error: 'Error al analizar el perfil. Intenta de nuevo.',
                    loading: false
                });
            }
        }

        async function downloadResult() {
            const resultCard = document.getElementById('result-card');
            if (!resultCard) return;

            try {
                const canvas = await html2canvas(resultCard, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false
                });

                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'cinematch-profile.png';
                    a.click();
                    URL.revokeObjectURL(url);
                });
            } catch (err) {
                console.error('Error generating image:', err);
            }
        }

        async function downloadCompatibilityResult() {
            const resultCard = document.getElementById('compatibility-result-card');
            if (!resultCard) return;

            try {
                const canvas = await html2canvas(resultCard, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false
                });

                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'cinematch-compatibility.png';
                    a.click();
                    URL.revokeObjectURL(url);
                });
            } catch (err) {
                console.error('Error generating image:', err);
            }
        }

        function resetApp() {
            console.log('Resetting app...');
            stopAutoSlide();
            stopSwipeIndicatorTimer();
            clearLocalStorage();

            // Reset completo del state a valores iniciales
            setState({
                image: null,
                loading: false,
                result: null,
                error: null,
                useMock: false,
                currentSlide: 0,
                autoSlideEnabled: true,
                hasCompletedCycle: false,
                hasScrolledToResults: false,
                wasRestoredFromStorage: false,
                profileCode: null,
                view: 'home',
                compatibilityResult: null,
                compatibilityUser: null,
                compatibilityCrush: null
                // pronoun y crushPronoun se mantienen para no perder la selecci√≥n del usuario
            });
        }

        function copyProfileCode() {
            if (state.profileCode) {
                navigator.clipboard.writeText(state.profileCode).then(() => {
                    const icon = document.getElementById('copy-icon');
                    if (icon) {
                        icon.textContent = '‚úÖ';
                        setTimeout(() => {
                            icon.textContent = 'üìã';
                        }, 2000);
                    }
                });
            }
        }

        function goToCompatibilityMatcher() {
            setState({
                view: 'compatibility-input',
                hasScrolledToResults: false,
                currentSlide: 0,
                autoSlideEnabled: true,
                hasCompletedCycle: false,
                wasRestoredFromStorage: false
            });
        }

        function setUserInputType(type) {
            const current = state.compatibilityUser || {};
            setState({
                compatibilityUser: {
                    inputType: type,
                    // Solo mantener code o screenshot seg√∫n el tipo
                    ...(type === 'code' && current.code ? { code: current.code } : {}),
                    ...(type === 'screenshot' && current.screenshot ? { screenshot: current.screenshot } : {})
                }
            });
        }

        function setCrushInputType(type) {
            const current = state.compatibilityCrush || {};
            setState({
                compatibilityCrush: {
                    inputType: type,
                    // Solo mantener code o screenshot seg√∫n el tipo
                    ...(type === 'code' && current.code ? { code: current.code } : {}),
                    ...(type === 'screenshot' && current.screenshot ? { screenshot: current.screenshot } : {})
                }
            });
        }

        function handleUserCodeChange(value) {
            const upperValue = value.toUpperCase();
            const newUser = state.compatibilityUser || {};
            setState({
                compatibilityUser: {
                    ...newUser,
                    inputType: newUser.inputType || 'code',
                    code: upperValue
                }
            });
            // Update input value to uppercase
            const input = document.getElementById('user-code-input');
            if (input && input.value !== upperValue) {
                input.value = upperValue;
            }
        }

        function handleCrushCodeChange(value) {
            const upperValue = value.toUpperCase();
            const newCrush = state.compatibilityCrush || {};
            setState({
                compatibilityCrush: {
                    ...newCrush,
                    inputType: newCrush.inputType || 'code',
                    code: upperValue
                }
            });
            // Update input value to uppercase
            const input = document.getElementById('crush-code-input');
            if (input && input.value !== upperValue) {
                input.value = upperValue;
            }
        }

        function handleUserScreenshotChange(file) {
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    setState({
                        compatibilityUser: {
                            ...state.compatibilityUser,
                            screenshot: e.target.result
                        }
                    });
                };
                reader.readAsDataURL(file);
            }
        }

        function handleCrushScreenshotChange(file) {
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    setState({
                        compatibilityCrush: {
                            ...state.compatibilityCrush,
                            screenshot: e.target.result
                        }
                    });
                };
                reader.readAsDataURL(file);
            }
        }

        function canAnalyzeCompatibility() {
            const userReady = (state.compatibilityUser?.inputType === 'code' && state.compatibilityUser?.code?.length === 6) ||
                             (state.compatibilityUser?.inputType === 'screenshot' && state.compatibilityUser?.screenshot);

            const crushReady = (state.compatibilityCrush?.inputType === 'code' && state.compatibilityCrush?.code?.length === 6) ||
                              (state.compatibilityCrush?.inputType === 'screenshot' && state.compatibilityCrush?.screenshot);

            // Debug logging
            if (isDevelopment) {
                console.log('[canAnalyzeCompatibility]', {
                    user: {
                        inputType: state.compatibilityUser?.inputType,
                        code: state.compatibilityUser?.code,
                        codeLength: state.compatibilityUser?.code?.length,
                        hasScreenshot: !!state.compatibilityUser?.screenshot,
                        ready: userReady
                    },
                    crush: {
                        inputType: state.compatibilityCrush?.inputType,
                        code: state.compatibilityCrush?.code,
                        codeLength: state.compatibilityCrush?.code?.length,
                        hasScreenshot: !!state.compatibilityCrush?.screenshot,
                        ready: crushReady
                    },
                    canAnalyze: userReady && crushReady
                });
            }

            return userReady && crushReady;
        }

        async function analyzeCompatibility() {
            if (!canAnalyzeCompatibility()) return;

            setState({ loading: true, error: null, wasRestoredFromStorage: false });

            try {
                // Preparar datos de usuario
                const userData = {
                    type: state.compatibilityUser.inputType,
                    value: state.compatibilityUser.inputType === 'code'
                        ? state.compatibilityUser.code
                        : state.compatibilityUser.screenshot.split(',')[1] // base64
                };

                // Preparar datos de crush
                const crushData = {
                    type: state.compatibilityCrush.inputType,
                    value: state.compatibilityCrush.inputType === 'code'
                        ? state.compatibilityCrush.code
                        : state.compatibilityCrush.screenshot.split(',')[1] // base64
                };

                // Llamar a la API de compatibilidad
                const response = await fetch('/api/compatibility', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user: userData,
                        crush: crushData,
                        useMock: state.useMock,
                        pronoun: state.pronoun,
                        crushPronoun: state.crushPronoun
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                let analysisText = data.content.find(item => item.type === 'text')?.text || '';
                analysisText = analysisText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();

                const compatibilityResult = JSON.parse(analysisText);
                setState({
                    compatibilityResult,
                    loading: false,
                    view: 'compatibility-results',
                    currentSlide: 0,
                    autoSlideEnabled: true,
                    hasCompletedCycle: false
                });

            } catch (err) {
                console.error('Error:', err);
                setState({
                    error: 'Error al analizar compatibilidad. Intenta de nuevo.',
                    loading: false
                });
            }
        }

        // Slide navigation functions - tiempos mucho m√°s largos
        const SLIDE_DURATIONS = [15000, 20000, 18000, 25000, 25000]; // Duration for each slide in ms
        const TOTAL_SLIDES = 5;

        function nextSlide() {
            stopSwipeIndicatorTimer();
            if (state.currentSlide < TOTAL_SLIDES - 1) {
                setState({
                    currentSlide: state.currentSlide + 1
                });
                if (state.autoSlideEnabled) {
                    startAutoSlide();
                }
            } else {
                // Reached the end, disable auto-slide
                setState({ hasCompletedCycle: true, autoSlideEnabled: false });
                stopAutoSlide();
            }
        }

        function prevSlide() {
            stopSwipeIndicatorTimer();
            if (state.currentSlide > 0) {
                // Going backwards disables auto-slide
                setState({
                    currentSlide: state.currentSlide - 1,
                    autoSlideEnabled: false
                });
                stopAutoSlide();
            }
        }

        function goToSlide(index) {
            stopSwipeIndicatorTimer();
            if (index >= 0 && index < TOTAL_SLIDES) {
                // User clicked on a dot - disable auto-slide
                setState({
                    currentSlide: index,
                    autoSlideEnabled: false
                });
                stopAutoSlide();
            }
        }

        function startAutoSlide() {
            if (!state.autoSlideEnabled) return;

            stopAutoSlide();
            stopSwipeIndicatorTimer();

            const duration = SLIDE_DURATIONS[state.currentSlide];
            const indicatorDelay = Math.max(3000, duration - 5000); // Mostrar 5s antes del autoswipe, m√≠nimo despu√©s de 3s

            // Solo mostrar nudge si NO es la √∫ltima slide
            if (state.currentSlide < TOTAL_SLIDES - 1) {
                // Mostrar nudge antes del autoswipe
                state.swipeIndicatorTimer = setTimeout(() => {
                    const slideContent = document.querySelector('.slide-content');
                    if (slideContent) {
                        slideContent.classList.add('slide-nudge');
                        // Remover la clase despu√©s de la animaci√≥n (4.5s = 1.5s * 3 repeticiones)
                        setTimeout(() => {
                            slideContent.classList.remove('slide-nudge');
                        }, 4500);
                    }
                }, indicatorDelay);

                // Auto-slide despu√©s del tiempo completo
                state.autoSlideTimer = setTimeout(() => {
                    if (state.currentSlide < TOTAL_SLIDES - 1 && state.autoSlideEnabled) {
                        nextSlide();
                    }
                }, duration);
            }
        }

        function stopAutoSlide() {
            if (state.autoSlideTimer) {
                clearTimeout(state.autoSlideTimer);
                state.autoSlideTimer = null;
            }
        }

        function stopSwipeIndicatorTimer() {
            if (state.swipeIndicatorTimer) {
                clearTimeout(state.swipeIndicatorTimer);
                state.swipeIndicatorTimer = null;
            }
        }

        function handleTouchStart(e) {
            state.touchStartX = e.touches[0].clientX;
            state.touchStartY = e.touches[0].clientY;
            stopAutoSlide();
        }

        function handleTouchMove(e) {
            state.touchEndX = e.touches[0].clientX;
            state.touchEndY = e.touches[0].clientY;
        }

        function handleTouchEnd() {
            const swipeThreshold = 80; // Aumentado de 50 a 80px para reducir sensibilidad
            const diffX = state.touchStartX - state.touchEndX;
            const diffY = state.touchStartY - state.touchEndY;

            const absX = Math.abs(diffX);
            const absY = Math.abs(diffY);

            // Solo hacer swipe si el movimiento horizontal es mayor que el vertical
            // Y si supera el threshold
            if (absX > swipeThreshold && absX > absY * 1.5) {
                // User swiped manually - disable auto-slide
                stopSwipeIndicatorTimer();
                setState({ autoSlideEnabled: false });
                if (diffX > 0) {
                    // Swipe left - next slide
                    nextSlide();
                } else {
                    // Swipe right - previous slide
                    prevSlide();
                }
            } else {
                // Resume auto-slide if no swipe detected
                if (state.autoSlideEnabled) {
                    startAutoSlide();
                }
            }
        }

        function getCompatibilitySlideContent(slideIndex, result) {
            switch(slideIndex) {
                case 0: // Porcentaje + Arquetipo Relacional
                    return `
                        <div class="h-full flex flex-col justify-center">
                            <div class="text-center mb-6">
                                <h2 class="text-3xl font-bold mb-2 text-[#ff006e]">CINEMATCH</h2>
                                <p class="text-sm text-gray-400">An√°lisis de Compatibilidad</p>
                            </div>

                            <div class="bg-[#2c3440] rounded-2xl p-6 border-2 border-[#ff006e]">
                                <div class="text-center mb-4">
                                    <div class="text-6xl font-bold text-[#ff006e] mb-2">${result.compatibility_percentage}%</div>
                                    <p class="text-xs text-gray-400">COMPATIBILIDAD</p>
                                </div>

                                <div class="text-center mb-4">
                                    <div class="text-4xl mb-2">${result.relationship_archetype?.emoji || 'üé≠'}</div>
                                    <h3 class="text-xl font-bold text-[#ffd93d] mb-1">
                                        ${result.relationship_archetype?.title || 'SU ARQUETIPO'}
                                    </h3>
                                    <p class="text-xs text-gray-400 italic">
                                        (${result.relationship_archetype?.subtitle || result.relationship_archetype?.title || 'The Archetype'})
                                    </p>
                                </div>

                                <p class="text-sm leading-relaxed text-gray-200">
                                    ${result.relationship_archetype?.description || ''}
                                </p>
                            </div>
                        </div>
                    `;

                case 1: // La Primera Cita
                    return `
                        <div class="h-full flex flex-col justify-center">
                            <div class="text-center mb-6">
                                <div class="text-5xl mb-2">üé¨</div>
                                <h3 class="text-2xl font-bold text-[#ffd93d]">LA PRIMERA CITA</h3>
                                <p class="text-xs text-gray-400 mt-1">Una simulaci√≥n basada en sus perfiles</p>
                            </div>

                            <div class="bg-[#2c3440] rounded-2xl p-6 border border-[#445566]">
                                <p class="text-sm leading-relaxed text-gray-200">
                                    ${result.first_date_scenario?.narrative || ''}
                                </p>
                            </div>
                        </div>
                    `;

                case 2: // Red Flags vs Green Flags
                    return `
                        <div class="h-full flex flex-col justify-center">
                            <div class="text-center mb-6">
                                <div class="text-5xl mb-2">‚öñÔ∏è</div>
                                <h3 class="text-2xl font-bold text-[#ffd93d]">LA DIN√ÅMICA</h3>
                            </div>

                            <div class="space-y-4">
                                <div class="bg-[#2c3440] rounded-xl p-5 border border-[#00d9a3]">
                                    <h4 class="text-sm font-bold text-[#00d9a3] mb-3 flex items-center gap-2">
                                        <span>‚ú®</span> GREEN FLAGS:
                                    </h4>
                                    <div class="space-y-2">
                                        ${(result.dynamics?.green_flags || []).map(flag => `
                                            <div class="flex items-start gap-2">
                                                <span class="text-lg">${flag.emoji}</span>
                                                <p class="text-sm text-gray-200">${flag.text}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="bg-[#2c3440] rounded-xl p-5 border border-[#ff4757]">
                                    <h4 class="text-sm font-bold text-[#ff4757] mb-3 flex items-center gap-2">
                                        <span>‚ö†Ô∏è</span> RED FLAGS POTENCIALES:
                                    </h4>
                                    <div class="space-y-2">
                                        ${(result.dynamics?.red_flags || []).map(flag => `
                                            <div class="flex items-start gap-2">
                                                <span class="text-lg">${flag.emoji}</span>
                                                <p class="text-sm text-gray-200">${flag.text}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                case 3: // Partner Material o Situationship
                    return `
                        <div class="h-full flex flex-col justify-center">
                            <div class="text-center mb-6">
                                <div class="text-5xl mb-2">üîÆ</div>
                                <h3 class="text-2xl font-bold text-[#ffd93d]">EL VEREDICTO</h3>
                            </div>

                            <div class="bg-[#2c3440] rounded-2xl p-6 border-2 border-[#ff006e]">
                                <div class="text-center mb-4">
                                    <h4 class="text-3xl font-bold text-white mb-2">
                                        ${result.verdict?.category || 'Partner Material üíç'}
                                    </h4>
                                </div>

                                <p class="text-sm leading-relaxed text-gray-200 mb-4">
                                    ${result.verdict?.reasoning || ''}
                                </p>

                                <div class="pt-4 border-t border-[#445566]">
                                    <p class="text-xs text-gray-400 mb-1">Predicci√≥n de timeline:</p>
                                    <p class="text-sm text-[#ffd93d] font-semibold">
                                        ${result.verdict?.timeline_prediction || ''}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;

                case 4: // Pel√≠culas + Consejo
                    return `
                        <div class="h-full flex flex-col justify-center overflow-y-auto">
                            <div class="text-center mb-6">
                                <div class="text-5xl mb-2">üéûÔ∏è</div>
                                <h3 class="text-2xl font-bold text-[#ffd93d]">PLAN DE ACCI√ìN</h3>
                            </div>

                            <div class="space-y-4">
                                <div class="bg-[#2c3440] rounded-xl p-5 border border-[#445566]">
                                    <h4 class="text-sm font-bold text-[#ffd93d] mb-3">
                                        üçø Pel√≠culas para ver juntos:
                                    </h4>
                                    <div class="space-y-3">
                                        ${(result.action_plan?.movies_to_watch || []).map(movie => `
                                            <div>
                                                <p class="text-sm font-semibold text-white">${movie.title}</p>
                                                <p class="text-xs text-gray-400">${movie.reason}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="bg-[#2c3440] rounded-xl p-5 border-2 border-[#ff006e]">
                                    <h4 class="text-sm font-bold text-[#ff006e] mb-2">
                                        üí° Consejo final:
                                    </h4>
                                    <p class="text-sm leading-relaxed text-gray-200">
                                        ${result.action_plan?.final_advice || ''}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;

                default:
                    return '<div>Slide no encontrada</div>';
            }
        }

        function getSlideContent(slideIndex, result) {
            switch(slideIndex) {
                case 0: // Arquetipo + Bio
                    return `
                        <div class="h-full flex flex-col justify-center">
                            <div class="text-center mb-6">
                                <h2 class="text-3xl font-bold mb-2 text-[#ff006e]">CINEMATCH</h2>
                                <p class="text-sm text-gray-400">Tu Dating Profile Cinematogr√°fico</p>
                            </div>

                            <div class="bg-[#2c3440] rounded-2xl p-6 border-2 border-[#ff006e]">
                                <div class="text-center mb-4">
                                    <div class="text-4xl mb-2">${result.archetype?.emoji || 'üé≠'}</div>
                                    <h3 class="text-2xl font-bold text-[#ffd93d] mb-1">
                                        ${result.archetype?.title || 'TU ARQUETIPO'}
                                    </h3>
                                    <p class="text-xs text-gray-400 italic">
                                        (${result.archetype?.subtitle || result.archetype?.title || 'The Archetype'})
                                    </p>
                                </div>

                                <p class="text-sm leading-relaxed text-gray-200 mb-4">
                                    ${result.archetype?.description || result.bio}
                                </p>

                                ${result.archetype?.rarity ? `
                                    <div class="text-center pt-4 border-t border-[#445566]">
                                        <p class="text-xs text-gray-400">Rareza:</p>
                                        <p class="text-lg font-bold text-[#ff006e]">${result.archetype.rarity}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;

                case 1: // First Date Reactions
                    return `
                        <div class="h-full flex flex-col justify-center">
                            <div class="text-center mb-6">
                                <div class="text-5xl mb-2">üí¨</div>
                                <h3 class="text-2xl font-bold text-[#ffd93d]">FIRST DATE REACTIONS</h3>
                                <p class="text-xs text-gray-400 mt-1">Lo que dijeron despu√©s de salir contigo</p>
                            </div>

                            <div class="space-y-4">
                                ${(result.firstDateReactions || []).map(reaction => `
                                    <div class="bg-[#2c3440] rounded-xl p-4 border border-[#445566]">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-sm font-semibold text-[#ffd93d]">${reaction.user}</span>
                                            <span class="text-sm text-[#ff006e]">${reaction.rating}</span>
                                        </div>
                                        <p class="text-sm leading-relaxed text-gray-300">"${reaction.comment}"</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;

                case 2: // Love Languages
                    return `
                        <div class="h-full flex flex-col justify-center">
                            <div class="text-center mb-6">
                                <div class="text-5xl mb-2">‚ù§Ô∏è</div>
                                <h3 class="text-2xl font-bold text-[#ffd93d]">C√ìMO AMAS</h3>
                                <p class="text-xs text-gray-400 mt-1">Seg√∫n tu Letterboxd</p>
                            </div>

                            <div class="space-y-4">
                                <div class="bg-[#2c3440] rounded-xl p-5 border border-[#ff006e]">
                                    <h4 class="text-sm font-bold text-[#ff006e] mb-3 flex items-center gap-2">
                                        <span>üíò</span> EN CITAS:
                                    </h4>
                                    <p class="text-sm leading-relaxed text-gray-200">
                                        ${result.loveLanguages?.dating || 'Tu forma de coquetear involucra referencias cinematogr√°ficas que solo 3 personas van a entender.'}
                                    </p>
                                </div>

                                <div class="bg-[#2c3440] rounded-xl p-5 border border-[#445566]">
                                    <h4 class="text-sm font-bold text-[#ffd93d] mb-3 flex items-center gap-2">
                                        <span>ü§ù</span> EN GENERAL:
                                    </h4>
                                    <p class="text-sm leading-relaxed text-gray-200">
                                        ${result.loveLanguages?.general || 'Expresas afecto a trav√©s de experiencias compartidas, no palabras vac√≠as.'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;

                case 3: // Best/Worst Matches
                    return `
                        <div class="h-full flex flex-col justify-center overflow-y-auto">
                            <div class="text-center mb-4">
                                <div class="text-5xl mb-2">üíò</div>
                                <h3 class="text-2xl font-bold text-[#ffd93d]">COMPATIBILITY</h3>
                            </div>

                            <!-- Best Matches -->
                            <div class="mb-4">
                                <h4 class="text-lg font-bold text-[#00d9a3] mb-3 flex items-center gap-2">
                                    <span>‚ú®</span> BEST MATCHES
                                </h4>
                                <div class="space-y-3">
                                    ${(result.bestMatches || []).map(match => `
                                        <div class="bg-[#2c3440] rounded-xl p-4 border border-[#00d9a3]">
                                            <div class="flex items-center justify-between mb-2">
                                                <h5 class="text-sm font-bold text-white">${match.emoji || 'üé≠'} ${match.type}</h5>
                                                <span class="text-sm font-bold text-[#00d9a3]">${match.percentage || '89%'}</span>
                                            </div>
                                            <p class="text-xs text-gray-300 mb-1">‚Üí ${match.dating}</p>
                                            <p class="text-xs text-gray-400">‚Üí ${match.general}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Worst Matches -->
                            <div>
                                <h4 class="text-lg font-bold text-[#ff4757] mb-3 flex items-center gap-2">
                                    <span>üíî</span> WORST MATCHES
                                </h4>
                                <div class="space-y-3">
                                    ${(result.worstMatches || []).map(match => `
                                        <div class="bg-[#2c3440] rounded-xl p-4 border border-[#ff4757]">
                                            <div class="flex items-center justify-between mb-2">
                                                <h5 class="text-sm font-bold text-white">${match.emoji || 'üé™'} ${match.type}</h5>
                                                <span class="text-sm font-bold text-[#ff4757]">${match.percentage || '9%'}</span>
                                            </div>
                                            <p class="text-xs text-gray-300 mb-1">‚Üí ${match.dating}</p>
                                            <p class="text-xs text-gray-400">‚Üí ${match.general}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;

                case 4: // Veredicto Final
                    return `
                        <div class="h-full flex flex-col justify-center">
                            <div class="text-center mb-6">
                                <div class="text-5xl mb-2">üìã</div>
                                <h3 class="text-2xl font-bold text-[#ffd93d]">VEREDICTO FINAL</h3>
                            </div>

                            <div class="bg-[#2c3440] rounded-2xl p-6 border border-[#445566] overflow-y-auto max-h-[600px]">
                                ${(result.verdict || []).map(paragraph => `
                                    <p class="text-sm leading-relaxed text-gray-200 mb-4 last:mb-0">
                                        ${paragraph}
                                    </p>
                                `).join('')}
                            </div>
                        </div>
                    `;

                default:
                    return '<div>Slide no encontrada</div>';
            }
        }

        function render() {
            const root = document.getElementById('root');
            
            root.innerHTML = `
                <!-- Header -->
                <div class="text-center mb-8">
                    <h1 class="text-5xl font-bold text-[#ff006e] mb-2">
                        CINEMATCH
                    </h1>
                    <p class="text-gray-400 text-lg">Tu Dating Profile Cinematogr√°fico</p>
                </div>

                ${state.view === 'home' ? `
                <!-- Pronoun Selection -->
                <div class="bg-[#14181c] rounded-2xl shadow-xl p-6 mb-6 border border-[#2c3440]">
                    <div class="text-center mb-4">
                        <h3 class="font-bold text-lg text-[#ffd93d] mb-2">Pronombres</h3>
                        <p class="text-sm text-gray-400">¬øC√≥mo quieres que hablemos de ti?</p>
                    </div>
                    <div class="flex gap-3">
                        <button
                            onclick="setState({ pronoun: 'masculino' })"
                            class="flex-1 py-3 rounded-lg font-semibold transition-all ${state.pronoun === 'masculino' ? 'bg-[#ff006e] text-white' : 'bg-[#2c3440] text-gray-300 hover:bg-[#3a4554]'}"
                        >
                            √âl
                        </button>
                        <button
                            onclick="setState({ pronoun: 'femenino' })"
                            class="flex-1 py-3 rounded-lg font-semibold transition-all ${state.pronoun === 'femenino' ? 'bg-[#ff006e] text-white' : 'bg-[#2c3440] text-gray-300 hover:bg-[#3a4554]'}"
                        >
                            Ella
                        </button>
                        <button
                            onclick="setState({ pronoun: 'neutro' })"
                            class="flex-1 py-3 rounded-lg font-semibold transition-all ${state.pronoun === 'neutro' ? 'bg-[#ff006e] text-white' : 'bg-[#2c3440] text-gray-300 hover:bg-[#3a4554]'}"
                        >
                            Elle
                        </button>
                    </div>
                </div>

                <!-- Upload Section -->
                <div class="bg-[#14181c] rounded-2xl shadow-xl p-8 mb-6 border border-[#2c3440]">
                    <div class="text-center mb-6">
                        <p class="text-gray-300 mb-4">
                            Sube un screenshot de tu perfil de Letterboxd con tus 4 pel√≠culas favoritas y √∫ltimas vistas
                        </p>
                    </div>

                    <label class="flex flex-col items-center justify-center w-full h-64 border-2 border-dashed border-[#445566] rounded-xl cursor-pointer hover:border-[#ff006e] transition-all bg-[#1a1f26] hover:bg-[#2c3440]">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <svg class="w-12 h-12 mb-3 text-[#ff006e]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            <p class="mb-2 text-sm text-gray-300">
                                <span class="font-semibold">Click para subir</span> o arrastra aqu√≠
                            </p>
                            <p class="text-xs text-gray-500">PNG, JPG (MAX. 5MB)</p>
                        </div>
                        <input 
                            type="file" 
                            class="hidden" 
                            accept="image/*"
                            id="file-input"
                        />
                    </label>

                    ${state.image ? `
                        <div class="mt-6">
                            <img src="${state.image}" alt="Preview" class="rounded-lg mx-auto max-h-64 object-contain" />

                            ${!isProduction ? `
                                <div class="mt-4 p-3 bg-[#2c3440] border border-[#ffd93d] rounded-lg">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            id="mock-checkbox"
                                            ${state.useMock ? 'checked' : ''}
                                            onchange="setState({ useMock: this.checked })"
                                            class="w-4 h-4 text-[#ffd93d] rounded focus:ring-[#ffd93d]"
                                        />
                                        <span class="text-sm text-[#ffd93d] font-medium">
                                            üõ†Ô∏è Modo Debug (usar mock data - solo dev/preview)
                                        </span>
                                    </label>
                                </div>
                            ` : ''}

                            <button
                                onclick="analyzeProfile()"
                                ${state.loading ? 'disabled' : ''}
                                class="w-full mt-4 bg-[#ff006e] text-white py-4 rounded-xl font-semibold text-lg hover:bg-[#e6006a] transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                ${state.loading ? 'üé¨ Analizando tu taste...' : 'üíò Generar Mi Perfil'}
                            </button>
                        </div>
                    ` : ''}

                    ${state.error ? `
                        <div class="mt-4 p-4 bg-[#2c3440] border border-[#ff4757] rounded-lg text-[#ff4757] text-center">
                            ${state.error}
                        </div>
                    ` : ''}
                </div>

                <!-- Instructions -->
                <div class="bg-[#14181c] rounded-2xl shadow-lg p-6 border border-[#2c3440] mb-6">
                    <h3 class="font-bold text-lg mb-3 text-[#ffd93d]">üì∏ C√≥mo tomar tu screenshot:</h3>
                    <ol class="space-y-2 text-gray-300">
                        <li>1. Ve a tu perfil de Letterboxd</li>
                        <li>2. Aseg√∫rate que se vean tus 4 pel√≠culas favoritas</li>
                        <li>3. Aseg√∫rate que se vean tus √∫ltimas 4 pel√≠culas vistas</li>
                        <li>4. Toma screenshot y s√∫belo aqu√≠</li>
                    </ol>
                </div>

                <!-- Compatibility CTA -->
                <div class="bg-[#14181c] rounded-2xl shadow-lg p-6 border border-[#2c3440]">
                    <div class="text-center">
                        <div class="text-4xl mb-3">üíò</div>
                        <h3 class="font-bold text-lg mb-2 text-[#ff006e]">¬øYa tienes tu perfil?</h3>
                        <p class="text-gray-300 mb-4 text-sm">
                            Mide tu compatibilidad cinematogr√°fica con alguien m√°s
                        </p>
                        <button
                            onclick="goToCompatibilityMatcher()"
                            class="w-full bg-[#2c3440] text-[#ff006e] py-3 rounded-xl font-semibold hover:bg-[#3a4554] transition-all border-2 border-[#ff006e]"
                        >
                            üíò Medidor de Compatibilidad
                        </button>
                    </div>
                </div>
                ` : state.view === 'results' ? `
                <!-- Floating Slide Indicators - Always Visible -->
                <div class="slide-indicators-floating px-4 pt-3 pb-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            ${Array.from({length: TOTAL_SLIDES}).map((_, i) => `
                                <button
                                    onclick="goToSlide(${i})"
                                    class="slide-indicator ${i === state.currentSlide ? 'active' : ''} w-3 h-3 rounded-full transition-all cursor-pointer ${i === state.currentSlide ? 'bg-[#ff006e]' : i < state.currentSlide ? 'bg-[#ff006e] opacity-60 hover:opacity-80' : 'bg-[#445566] hover:bg-[#5a6678]'}"
                                    aria-label="Ir a slide ${i + 1}"
                                ></button>
                            `).join('')}
                        </div>
                        <div class="text-sm font-bold">
                            <span class="text-[#ff006e]">${state.currentSlide + 1}</span><span class="text-gray-500">/${TOTAL_SLIDES}</span>
                        </div>
                    </div>
                </div>

                <!-- Result Card with Slides -->
                <div class="space-y-6">
                    <div
                        id="result-card"
                        class="story-card bg-[#14181c] rounded-3xl shadow-2xl overflow-hidden mx-auto border border-[#2c3440] slide-container"
                        ontouchstart="handleTouchStart(event)"
                        ontouchmove="handleTouchMove(event)"
                        ontouchend="handleTouchEnd()"
                    >
                        <div class="h-full flex flex-col text-white relative">
                            <!-- Navigation Arrows (Desktop only) -->
                            <button
                                onclick="prevSlide()"
                                ${state.currentSlide === 0 ? 'disabled' : ''}
                                class="nav-arrow nav-arrow-left"
                                aria-label="Slide anterior"
                            >
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <button
                                onclick="nextSlide()"
                                ${state.currentSlide === TOTAL_SLIDES - 1 ? 'disabled' : ''}
                                class="nav-arrow nav-arrow-right"
                                aria-label="Siguiente slide"
                            >
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>

                            <!-- Slide Content -->
                            <div class="p-4 pt-16 slide-content overflow-y-auto" style="flex: 1 1 0; min-height: 0;">
                                ${getSlideContent(state.currentSlide, state.result)}
                            </div>

                            <!-- Footer -->
                            <div class="text-center py-3 flex-shrink-0 bg-[#14181c] border-t border-[#2c3440]" style="flex: 0 0 auto;">
                                ${state.profileCode ? `
                                    <div class="flex items-center justify-center gap-2 mb-1">
                                        <span class="text-xs text-gray-400">C√≥digo:</span>
                                        <button
                                            onclick="copyProfileCode()"
                                            class="text-sm font-bold text-[#ffd93d] hover:text-[#ffed93] transition-all flex items-center gap-1"
                                            title="Copiar c√≥digo"
                                        >
                                            ${state.profileCode}
                                            <span id="copy-icon" class="text-xs">üìã</span>
                                        </button>
                                    </div>
                                ` : ''}
                                <p class="text-[9px] text-gray-500">cinematch.app (fake lol)</p>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="space-y-4">
                        ${state.wasRestoredFromStorage ? `
                            <div class="bg-[#2c3440] border border-[#ffd93d] rounded-xl p-3 text-center">
                                <p class="text-sm text-[#ffd93d]">
                                    ‚ú® Tus resultados fueron restaurados
                                </p>
                            </div>
                        ` : ''}
                        <div class="flex gap-4">
                            <button
                                onclick="downloadResult()"
                                class="flex-1 bg-[#ff006e] text-white py-4 rounded-xl font-semibold text-lg hover:bg-[#e6006a] transition-all"
                            >
                                üì± Descargar para Stories
                            </button>
                            <button
                                onclick="resetApp()"
                                class="flex-1 bg-[#2c3440] text-gray-300 py-4 rounded-xl font-semibold text-lg hover:bg-[#3a4554] transition-all border border-[#445566]"
                            >
                                üîÑ Hacer Otro
                            </button>
                        </div>

                        <!-- Compatibility CTA -->
                        <div class="bg-[#14181c] rounded-2xl shadow-lg p-6 border-2 border-[#ff006e]">
                            <div class="text-center">
                                <div class="text-4xl mb-3">üíò</div>
                                <h3 class="font-bold text-lg mb-2 text-[#ffd93d]">¬øQu√© tan compatible eres con alguien m√°s?</h3>
                                <p class="text-gray-300 mb-4 text-sm">
                                    Mide tu compatibilidad cinematogr√°fica con tu crush
                                </p>
                                <button
                                    onclick="goToCompatibilityMatcher()"
                                    class="w-full bg-[#ff006e] text-white py-3 rounded-xl font-semibold hover:bg-[#e6006a] transition-all"
                                >
                                    üíò Medir Compatibilidad
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                ` : state.view === 'compatibility-input' ? `
                <!-- Compatibility Matcher UI -->
                <div class="space-y-6">
                    <div class="text-center mb-8">
                        <div class="text-5xl mb-3">üíò</div>
                        <h2 class="text-3xl font-bold text-[#ff006e] mb-2">
                            MEDIDOR DE COMPATIBILIDAD
                        </h2>
                        <p class="text-gray-400">Descubre qu√© tan compatible eres con tu crush</p>
                    </div>

                    <!-- Pronoun Selection for Compatibility -->
                    <div class="bg-[#14181c] rounded-2xl shadow-xl p-6 border border-[#2c3440]">
                        <div class="text-center mb-4">
                            <h3 class="font-bold text-lg text-[#ffd93d] mb-2">Pronombres</h3>
                            <p class="text-sm text-gray-400">¬øC√≥mo quieres que hablemos de ti en el an√°lisis?</p>
                        </div>
                        <div class="flex gap-3">
                            <button
                                onclick="setState({ pronoun: 'masculino' })"
                                class="flex-1 py-3 rounded-lg font-semibold transition-all ${state.pronoun === 'masculino' ? 'bg-[#ff006e] text-white' : 'bg-[#2c3440] text-gray-300 hover:bg-[#3a4554]'}"
                            >
                                √âl
                            </button>
                            <button
                                onclick="setState({ pronoun: 'femenino' })"
                                class="flex-1 py-3 rounded-lg font-semibold transition-all ${state.pronoun === 'femenino' ? 'bg-[#ff006e] text-white' : 'bg-[#2c3440] text-gray-300 hover:bg-[#3a4554]'}"
                            >
                                Ella
                            </button>
                            <button
                                onclick="setState({ pronoun: 'neutro' })"
                                class="flex-1 py-3 rounded-lg font-semibold transition-all ${state.pronoun === 'neutro' ? 'bg-[#ff006e] text-white' : 'bg-[#2c3440] text-gray-300 hover:bg-[#3a4554]'}"
                            >
                                Elle
                            </button>
                        </div>
                    </div>

                    <!-- Tu Perfil -->
                    <div class="bg-[#14181c] rounded-2xl shadow-xl p-6 border border-[#2c3440]">
                        <h3 class="font-bold text-lg mb-4 text-[#ffd93d]">üë§ Tu Perfil</h3>

                        <div class="mb-4">
                            <label class="block text-sm text-gray-400 mb-2">¬øC√≥mo quieres ingresar tu perfil?</label>
                            <div class="flex gap-4 mb-4">
                                <button
                                    onclick="setUserInputType('code')"
                                    class="flex-1 py-3 rounded-lg font-semibold transition-all ${state.compatibilityUser?.inputType === 'code' ? 'bg-[#ff006e] text-white' : 'bg-[#2c3440] text-gray-300 hover:bg-[#3a4554]'}"
                                >
                                    üìù C√≥digo
                                </button>
                                <button
                                    onclick="setUserInputType('screenshot')"
                                    class="flex-1 py-3 rounded-lg font-semibold transition-all ${state.compatibilityUser?.inputType === 'screenshot' ? 'bg-[#ff006e] text-white' : 'bg-[#2c3440] text-gray-300 hover:bg-[#3a4554]'}"
                                >
                                    üì∏ Screenshot
                                </button>
                            </div>
                        </div>

                        ${state.compatibilityUser?.inputType === 'code' ? `
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Ingresa tu c√≥digo de 6 d√≠gitos:</label>
                                <input
                                    type="text"
                                    id="user-code-input"
                                    maxlength="6"
                                    placeholder="A3K9M2"
                                    oninput="handleUserCodeChange(this.value)"
                                    class="w-full px-4 py-3 bg-[#2c3440] rounded-lg text-white font-mono text-lg focus:outline-none focus:ring-2 focus:ring-[#ff006e]"
                                />
                                <p class="text-xs text-gray-500 mt-2">üí° M√°s r√°pido y no gasta cr√©ditos de API</p>
                                <p class="text-xs text-gray-400 mt-1">El c√≥digo aparece al generar tu perfil. Si no lo tienes, usa screenshot.</p>
                            </div>
                        ` : state.compatibilityUser?.inputType === 'screenshot' ? `
                            <div>
                                <label class="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-[#445566] rounded-xl cursor-pointer hover:border-[#ff006e] transition-all bg-[#1a1f26] hover:bg-[#2c3440]">
                                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                        <svg class="w-10 h-10 mb-2 text-[#ff006e]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                        </svg>
                                        <p class="text-sm text-gray-300">
                                            <span class="font-semibold">Click para subir</span> o arrastra aqu√≠
                                        </p>
                                    </div>
                                    <input
                                        type="file"
                                        class="hidden"
                                        accept="image/*"
                                        id="user-screenshot-input"
                                        onchange="handleUserScreenshotChange(this.files[0])"
                                    />
                                </label>
                                ${state.compatibilityUser?.screenshot ? `
                                    <img src="${state.compatibilityUser.screenshot}" alt="Preview" class="mt-3 rounded-lg mx-auto max-h-32 object-contain" />
                                ` : ''}
                            </div>
                        ` : `
                            <p class="text-center text-gray-500 py-8">Selecciona una opci√≥n arriba</p>
                        `}
                    </div>

                    <!-- Perfil de Tu Crush -->
                    <div class="bg-[#14181c] rounded-2xl shadow-xl p-6 border border-[#2c3440]">
                        <h3 class="font-bold text-lg mb-4 text-[#ffd93d]">üíï Perfil de la Otra Persona</h3>

                        <!-- Crush Pronoun Selection -->
                        <div class="mb-4 pb-4 border-b border-[#2c3440]">
                            <label class="block text-sm text-gray-400 mb-2">¬øQu√© pronombres usa esta persona?</label>
                            <div class="flex gap-3">
                                <button
                                    onclick="setState({ crushPronoun: 'masculino' })"
                                    class="flex-1 py-2 rounded-lg font-semibold text-sm transition-all ${state.crushPronoun === 'masculino' ? 'bg-[#ff006e] text-white' : 'bg-[#2c3440] text-gray-300 hover:bg-[#3a4554]'}"
                                >
                                    √âl
                                </button>
                                <button
                                    onclick="setState({ crushPronoun: 'femenino' })"
                                    class="flex-1 py-2 rounded-lg font-semibold text-sm transition-all ${state.crushPronoun === 'femenino' ? 'bg-[#ff006e] text-white' : 'bg-[#2c3440] text-gray-300 hover:bg-[#3a4554]'}"
                                >
                                    Ella
                                </button>
                                <button
                                    onclick="setState({ crushPronoun: 'neutro' })"
                                    class="flex-1 py-2 rounded-lg font-semibold text-sm transition-all ${state.crushPronoun === 'neutro' ? 'bg-[#ff006e] text-white' : 'bg-[#2c3440] text-gray-300 hover:bg-[#3a4554]'}"
                                >
                                    Elle
                                </button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm text-gray-400 mb-2">¬øC√≥mo quieres ingresar su perfil?</label>
                            <div class="flex gap-4 mb-4">
                                <button
                                    onclick="setCrushInputType('code')"
                                    class="flex-1 py-3 rounded-lg font-semibold transition-all ${state.compatibilityCrush?.inputType === 'code' ? 'bg-[#ff006e] text-white' : 'bg-[#2c3440] text-gray-300 hover:bg-[#3a4554]'}"
                                >
                                    üìù C√≥digo
                                </button>
                                <button
                                    onclick="setCrushInputType('screenshot')"
                                    class="flex-1 py-3 rounded-lg font-semibold transition-all ${state.compatibilityCrush?.inputType === 'screenshot' ? 'bg-[#ff006e] text-white' : 'bg-[#2c3440] text-gray-300 hover:bg-[#3a4554]'}"
                                >
                                    üì∏ Screenshot
                                </button>
                            </div>
                        </div>

                        ${state.compatibilityCrush?.inputType === 'code' ? `
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Ingresa el c√≥digo de 6 d√≠gitos:</label>
                                <input
                                    type="text"
                                    id="crush-code-input"
                                    maxlength="6"
                                    placeholder="B7X4T8"
                                    oninput="handleCrushCodeChange(this.value)"
                                    class="w-full px-4 py-3 bg-[#2c3440] rounded-lg text-white font-mono text-lg focus:outline-none focus:ring-2 focus:ring-[#ff006e]"
                                />
                                <p class="text-xs text-gray-400 mt-2">El c√≥digo aparece al generar el perfil. Si no lo tienes, p√≠dele que te lo comparta o usa screenshot.</p>
                            </div>
                        ` : state.compatibilityCrush?.inputType === 'screenshot' ? `
                            <div>
                                <label class="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-[#445566] rounded-xl cursor-pointer hover:border-[#ff006e] transition-all bg-[#1a1f26] hover:bg-[#2c3440]">
                                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                        <svg class="w-10 h-10 mb-2 text-[#ff006e]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                        </svg>
                                        <p class="text-sm text-gray-300">
                                            <span class="font-semibold">Click para subir</span> o arrastra aqu√≠
                                        </p>
                                    </div>
                                    <input
                                        type="file"
                                        class="hidden"
                                        accept="image/*"
                                        id="crush-screenshot-input"
                                        onchange="handleCrushScreenshotChange(this.files[0])"
                                    />
                                </label>
                                ${state.compatibilityCrush?.screenshot ? `
                                    <img src="${state.compatibilityCrush.screenshot}" alt="Preview" class="mt-3 rounded-lg mx-auto max-h-32 object-contain" />
                                ` : ''}
                            </div>
                        ` : `
                            <p class="text-center text-gray-500 py-8">Selecciona una opci√≥n arriba</p>
                        `}
                    </div>

                    ${!isProduction ? `
                        <div class="bg-[#2c3440] border border-[#ffd93d] rounded-xl p-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input
                                    type="checkbox"
                                    id="mock-compatibility-checkbox"
                                    ${state.useMock ? 'checked' : ''}
                                    onchange="setState({ useMock: this.checked })"
                                    class="w-4 h-4 text-[#ffd93d] rounded focus:ring-[#ffd93d]"
                                />
                                <span class="text-sm text-[#ffd93d] font-medium">
                                    üõ†Ô∏è Modo Debug (usar mock data - solo dev/preview)
                                </span>
                            </label>
                        </div>
                    ` : ''}

                    <!-- Action Buttons -->
                    <div class="space-y-3">
                        <button
                            onclick="analyzeCompatibility()"
                            ${state.loading || !canAnalyzeCompatibility() ? 'disabled' : ''}
                            class="w-full bg-[#ff006e] text-white py-4 rounded-xl font-semibold text-lg hover:bg-[#e6006a] transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            ${state.loading ? 'üíò Analizando compatibilidad...' : 'üíò Analizar Compatibilidad'}
                        </button>
                        <button
                            onclick="resetApp()"
                            class="w-full bg-[#2c3440] text-gray-300 py-3 rounded-xl font-semibold hover:bg-[#3a4554] transition-all border border-[#445566]"
                        >
                            ‚Üê Volver al Inicio
                        </button>
                    </div>

                    ${state.error ? `
                        <div class="p-4 bg-[#2c3440] border border-[#ff4757] rounded-lg text-[#ff4757] text-center">
                            ${state.error}
                        </div>
                    ` : ''}
                </div>
                ` : state.view === 'compatibility-results' ? `
                <!-- Floating Slide Indicators for Compatibility -->
                <div class="slide-indicators-floating px-4 pt-3 pb-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            ${Array.from({length: TOTAL_SLIDES}).map((_, i) => `
                                <button
                                    onclick="goToSlide(${i})"
                                    class="slide-indicator ${i === state.currentSlide ? 'active' : ''} w-3 h-3 rounded-full transition-all cursor-pointer ${i === state.currentSlide ? 'bg-[#ff006e]' : i < state.currentSlide ? 'bg-[#ff006e] opacity-60 hover:opacity-80' : 'bg-[#445566] hover:bg-[#5a6678]'}"
                                    aria-label="Ir a slide ${i + 1}"
                                ></button>
                            `).join('')}
                        </div>
                        <div class="text-sm font-bold">
                            <span class="text-[#ff006e]">${state.currentSlide + 1}</span><span class="text-gray-500">/${TOTAL_SLIDES}</span>
                        </div>
                    </div>
                </div>

                <!-- Compatibility Result Card with Slides -->
                <div class="space-y-6">
                    <div
                        id="compatibility-result-card"
                        class="story-card bg-[#14181c] rounded-3xl shadow-2xl overflow-hidden mx-auto border border-[#2c3440] slide-container"
                        ontouchstart="handleTouchStart(event)"
                        ontouchmove="handleTouchMove(event)"
                        ontouchend="handleTouchEnd()"
                    >
                        <div class="h-full flex flex-col text-white relative">
                            <!-- Navigation Arrows (Desktop only) -->
                            <button
                                onclick="prevSlide()"
                                ${state.currentSlide === 0 ? 'disabled' : ''}
                                class="nav-arrow nav-arrow-left"
                                aria-label="Slide anterior"
                            >
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <button
                                onclick="nextSlide()"
                                ${state.currentSlide === TOTAL_SLIDES - 1 ? 'disabled' : ''}
                                class="nav-arrow nav-arrow-right"
                                aria-label="Siguiente slide"
                            >
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>

                            <!-- Slide Content -->
                            <div class="p-4 pt-16 slide-content overflow-y-auto" style="flex: 1 1 0; min-height: 0;">
                                ${getCompatibilitySlideContent(state.currentSlide, state.compatibilityResult)}
                            </div>

                            <!-- Footer -->
                            <div class="text-center py-3 flex-shrink-0 bg-[#14181c] border-t border-[#2c3440]" style="flex: 0 0 auto;">
                                <p class="text-[9px] text-gray-500">cinematch.app (fake lol)</p>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="space-y-4">
                        ${state.wasRestoredFromStorage ? `
                            <div class="bg-[#2c3440] border border-[#ffd93d] rounded-xl p-3 text-center">
                                <p class="text-sm text-[#ffd93d]">
                                    ‚ú® Tu an√°lisis de compatibilidad fue restaurado
                                </p>
                            </div>
                        ` : ''}
                        <div class="flex gap-4">
                            <button
                                onclick="downloadCompatibilityResult()"
                                class="flex-1 bg-[#ff006e] text-white py-4 rounded-xl font-semibold text-lg hover:bg-[#e6006a] transition-all"
                            >
                                üì± Descargar para Stories
                            </button>
                            <button
                                onclick="resetApp()"
                                class="flex-1 bg-[#2c3440] text-gray-300 py-4 rounded-xl font-semibold text-lg hover:bg-[#3a4554] transition-all border border-[#445566]"
                            >
                                üîÑ Hacer Otro
                            </button>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;

            // Re-attach event listener for file input
            const fileInput = document.getElementById('file-input');
            if (fileInput) {
                fileInput.addEventListener('change', handleImageUpload);
            }

            // Start auto-slide when result is shown (standard or compatibility)
            if ((state.result || state.compatibilityResult) && !state.autoSlideTimer) {
                startAutoSlide();
            }

            // Auto-scroll to center results when they appear (only once)
            if (state.result && !state.hasScrolledToResults) {
                const resultCard = document.getElementById('result-card');
                if (resultCard) {
                    state.hasScrolledToResults = true;
                    setTimeout(() => {
                        resultCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                }
            }

            // Auto-scroll for compatibility results
            if (state.compatibilityResult && !state.hasScrolledToResults) {
                const resultCard = document.getElementById('compatibility-result-card');
                if (resultCard) {
                    state.hasScrolledToResults = true;
                    setTimeout(() => {
                        resultCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                }
            }
        }

        // Load saved data on startup
        const savedData = loadFromLocalStorage();
        if (savedData) {
            console.log('Restoring from localStorage, type:', savedData.type);

            if (savedData.type === 'standard') {
                state.result = savedData.result;
                state.image = savedData.image;
                state.profileCode = savedData.profileCode;
                state.view = 'results';
                state.wasRestoredFromStorage = true;
                state.hasScrolledToResults = false; // Reset para que auto-scroll funcione
            } else if (savedData.type === 'compatibility') {
                state.compatibilityResult = savedData.compatibilityResult;
                state.view = 'compatibility-results';
                state.wasRestoredFromStorage = true;
                state.hasScrolledToResults = false; // Reset para que auto-scroll funcione
            }
        }

        // Initial render
        render();
    </script>
</body>
</html>
